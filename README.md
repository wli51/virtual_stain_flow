# Virtual Stain Flow

**A comprehensive deep learning framework for virtual staining of microscopy images**

Virtual Stain Flow provides a modular, extensible platform for training image-to-image translation models to generate virtual stains from label-free microscopy images. The framework includes everything from data loading and preprocessing to model training and evaluation.

## Example Results

Below is an example showcasing the input, target, and prediction generated by the Virtual Stain Flow framework:

![Input/Target/Prediction](./assets/epoch_299.png)

## Key Functionalities
- **Modular Architecture**: Composable blocks, stages, and models for flexible U-Net architectures
- **Comprehensive Datasets**: Flexible image loading with caching, cropping, and augmentation support
- **Training**: Support for both standard and adversarial (GAN, wGAN, wGAN-GP) training
- **Transforms**: Albumentations-compatible preprocessing with serialization

## Supported Model Architectures

Virtual Stain Flow supports a variety of model architectures tailored for image-to-image translation tasks:

- **U-Net**: Classical encoder-decoder architecture with skip connections. This architecture has been widely used for virtual staining tasks, as demonstrated in [Label-free prediction of three-dimensional fluorescence images from transmitted-light microscopy](https://doi.org/10.1038/s41592-018-0111-2), showcasing its effectiveness in generating high-quality fluorescence images from label-free inputs.
    - Customizable 
depth, the number of computational blocks per layer, and up/down sampling operations can be customized. Options for up/down sampling include MaxPooling, ConvTranspose2D, bilinear interpolation, and Conv2D, allowing for fine-grained control over the architecture's behavior and performance.
- **ConvNeXt-UNet**: Combines the ConvNeXt backbone for feature extraction with a U-Net-style decoder for enhanced performance on complex datasets. This architecture is inspired by advancements in robust virtual staining techniques, as demonstrated in [Cytoland](https://doi.org/10.1038/s42256-025-01046-2), which highlights the potential of deep learning for landmark organelle staining.

## Quick Start
For a detailed walkthrough of the training process, refer to the [examples/](./examples/) directory. It contains complete scripts and tutorials to help you get started quickly.
```python
# Import key components
from virtual_stain_flow.datasets import BaseImageDataset
from virtual_stain_flow.models import UNet
from virtual_stain_flow.trainers import LoggingTrainer
from virtual_stain_flow.transforms import MaxScaleNormalize
from virtual_stain_flow.logging import MlflowLogger

# Setup dataset
dataset = BaseImageDataset(
    file_index=file_df,
    input_channel_keys=['brightfield'],
    target_channel_keys=['fluorescence'],
    transform=MaxScaleNormalize(normalization_factor='16bit')
)

# Create model
model = UNet(
    in_channels=1,
    out_channels=1,
    channel_base=64,
    depth=4
)

# Setup training
trainer = LoggingTrainer(
    model=model,
    optimizer=torch.optim.Adam(model.parameters()),
    backprop_loss=torch.nn.L1Loss(),
    dataset=dataset,
    batch_size=16,
    train_for_epochs=100
)

# Train with logging
trainer.train()
```

## Project Structure

This framework is organized into several key modules:

### Core Components

- **[datasets/](./virtual_stain_flow/datasets/)** - Data loading and preprocessing pipelines
- **[models/](./virtual_stain_flow/models/)** - Neural network architectures and building blocks
- **[trainers/](./virtual_stain_flow/trainers/)** - Training loops and optimization strategies
- **[transforms/](./virtual_stain_flow/transforms/)** - Image preprocessing and augmentation
- **[metrics/](./virtual_stain_flow/metrics/)** - Evaluation metrics and quality assessment
- **[logging/](./virtual_stain_flow/logging/)** - Experiment tracking and result visualization

### Examples

Check out the **[examples/](./examples/)** directory for complete training scripts and tutorials demonstrating various use cases and configurations.

## Installation

```bash
git clone https://github.com/your-repo/virtual_stain_flow.git
cd virtual_stain_flow
pip install -e .
```

## Documentation

For detailed documentation on each module, please refer to the individual README files in each component directory. The examples directory contains comprehensive tutorials and use cases.

## License
This project is licensed under the BSD 3-Clause License. See the [LICENSE](./LICENSE) file for details.